angular.module("datoniApp.controllers").controller("MenuCartCtrl",function(e,n,r,t,s,o,i,a,d,n,c,u,l,p,g,h,f,l,m,b){"undefined"==typeof n.cart&&(n.cart=new r),e.account=new t,e.getPrice=function(e){if("undefined"==typeof e.addedIngredients||0==e.addedIngredients.length)return e.price;for(var n=e.price,r=.5,t=e.product.prices,s=0,o=t.length;o>s;s++)if(t[s].price==e.price)var i=t[s].size;switch(i){case"klein":r=.5;break;case"gross":r=.5;break;case"familie":r=1;break;default:r=1}return n+e.addedIngredients.length*r},e.getGeolocation=function(){n.$broadcast("loading:show"),c.getCurrentPosition({enableHighAccuracy:!0}).then(function(r){n.$broadcast("loading:hide");var t=[r.coords.latitude,r.coords.longitude].join(","),s=!1;o.get("http://maps.googleapis.com/maps/api/geocode/json?address="+t+"&sensor=true").success(function(n){var n=n.results[0].address_components;angular.forEach(n,function(n){n.types.indexOf("street_number")>-1&&(e.address.streetnumber=n.long_name),n.types.indexOf("route")>-1&&(e.address.street=n.short_name),n.types.indexOf("postal_code")>-1&&(e.address.postalcode=n.long_name),n.types.indexOf("sublocality")>-1&&(e.address.location=n.long_name,s=!0),!s&&n.types.indexOf("locality")>-1&&(e.address.location=n.long_name)}),e.saveAddress()}).error(function(e){n.$broadcast("loading:hide"),alert("Ihr Standort konnte nicht ermittelt werden.")})},function(e){alert("Ihr Standort konnte nicht ermittelt werden."),n.$broadcast("loading:hide")})},n.cart.items.length>0&&(n.cart.items[0].collapsed=!0),e.getRemovedIngredients=function(e){var n={};return angular.forEach(e.ingredients,function(e){n[e.name]=!0}),angular.forEach(e.removedIngredients,function(e){n[e]=!1}),n},e.editIngredients=function(n){e.editIngredientsItem=n,g.fromTemplateUrl("edit-ingredients.html",{scope:e,animation:"slide-in-up"}).then(function(n){e.modal=n,e.modal.show()})},e.saveIngredients=function(n,r){r.removedIngredients=[],angular.forEach(r.ingredients,function(e){n[e.name]!==!0&&r.removedIngredients.push(e.name)}),console.log(r),e.modal.hide()},e.o={},e.o.orderTypePickup=!1,e.o.orderTypeShipping=!0,e.$watch("o.orderTypePickup",function(){e.o.orderTypePickup&&(e.o.orderTypeShipping=!1,e.setOrderType("pickup"))}),e.$watch("o.orderTypeShipping",function(){e.o.orderTypeShipping&&(e.o.orderTypePickup=!1,e.setOrderType("shipping"))}),e.orderType="shipping",e.setOrderType=function(n){e.orderType=n,s.resize()},e.orderTime="sofort",e.resizeViewport=function(){s.resize()},e.address=l.get("user.address",{}),e.$on("user:address:updated",function(){e.address=l.get("user.address",{}),e.Mindestbestellwert=new p(e.address.location),e.canDeliver=b.canDeliverTo(e.address.location)}),e.saveAddress=function(){l.set("user.address",angular.copy(e.address)),e.hasAddress=e.isValidAddress(),n.$broadcast("user:address:updated",l.get("user.address"))},e.isValidAddress=function(){return e.address.location&&e.address.location.length>0&&e.address.postalcode&&e.address.firstname&&e.address.lastname&&e.address.street},e.Mindestbestellwert=new p(e.address.location),e.canDeliver=b.canDeliverTo(e.address.location),e.gotoMenu=function(){a.nextViewOptions({disableBack:!0}),u.go("tab.menu.list")},e.cart=n.cart,e.message="",e.leaveMessage=function(){g.fromTemplateUrl("add-message.html",{scope:e,animation:"slide-in-up"}).then(function(n){e.modal=n,e.modal.show()})},e.saveMessage=function(n){e.message=document.querySelector("#message_field").value,e.hasMessage=e.message.length>0?!0:!1,e.modal.hide(),console.log(e.hasMessage)},e.closeModal=function(){e.modal.hide()},e.completeOrder=function(){if(0==e.cart.items.length)return f.alert("Dein Warenkorb ist leer, bitte suche dir aus der Speisekarte ein Gericht aus & versuche es erneut.","Da Toni App","OK"),u.go("tab.menu.list"),!1;if("undefined"==typeof e.address.lastname||"undefined"==typeof e.address.firstname||"undefined"==typeof e.address.street||"undefined"==typeof e.address.location)return f.alert("Du hast keine gültige Adresse angegeben, bitte gehe in dein Profil und gebe deine Addresse ein.","Da Toni App","OK"),!1;if(""===e.address.lastname||""===e.address.firstname||""===e.address.street||""===e.address.location)return f.alert("Du hast keine gültige Adresse angegeben, bitte gehe in dein Profil und gebe deine Addresse ein.","Da Toni App","OK"),!1;if(!1)return f.alert("Du versuchst außerhalb unserer Geschäftszeiten eine Bestellung zu machen, das ist leider nicht möglich. Bitte versuche es später noch einmal.","Da Toni App","OK"),!1;var r={};if(r.use_coupons=n.useCoupons,r.cart=e.cart.getPostData(),r.user=(new t).getCredentials(),r.address=angular.copy(e.address),r.delivery=e.orderType,r.message=e.message.substring(0,140),"shipping"==r.delivery){if(e.Mindestbestellwert.getLevel().price>e.getTotalCost())return f.alert("Deine Bestellung erfüllt nicht die Auflagen unseres Mindestbestellwerts. Bitte passe deine Bestellung an und versuche es ggf. erneut.","Da Toni App","OK"),!1;-1==e.Mindestbestellwert.getLevel().price&&f.alert("Wir konnten deinen Standort nicht genau zu ordnen, es kann sein, dass du dich außerhalb unseres Lieferradius befindest.\nWir werden uns telefonisch bei dir melden, sollte deine Bestellung nicht ausgeliefert werden können.","Da Toni App","OK")}o.post(i.to("orders/submit"),r).success(function(r){if(!r.id)return alert("Wir konnten die Bestellung nicht übermitteln.\nBitte versuche es erneut oder ruf uns persönlich an."),n.$broadcast("loading:hide"),!1;n.useCoupons=!1,n.lastOrderId=r.id,n.lastCart=angular.copy(e.cart);var t=l.get("user.orders",[]),s=new Date;r.date=s.getDate()+"."+s.getMonth()+"."+s.getFullYear()+" "+s.getHours()+":"+s.getMinutes(),t.push(r),l.set("user.orders",t),g.fromTemplateUrl("templates/profile/order_success.html",{scope:e,animation:"slide-in-up"}).then(function(n){window.$orderModal=n,e.modal=n,e.modal.show()})})["catch"](function(){return alert("Wir konnten die Bestellung nicht übermitteln.\nBitte versuche es erneut oder ruf uns persönlich an."),n.$broadcast("loading:hide"),!1})["finally"](function(){n.$broadcast("loading:hide")})},n.$on("cart:clear",function(){e.cart.clear(),n.badge.cart=0}),e.getHours=function(){for(var e=11,n=[];23>e;)n.push(e++);return n},e.changeSize=function(n,r){e.popoverItem=r,m.fromTemplateUrl("size-popover.html",{scope:e}).then(function(r){e.popover=r,e.popover.show(n)})},e.setPrice=function(n,r){n.size=r.size,n.price=r.price,e.popover.hide()},e.getTotalCost=function(r){"undefined"==typeof r&&(r=!0);var t=0;return angular.forEach(e.cart.items,function(n){t+=e.getPrice(n)*n.quantity}),r&&n.useCoupons&&t>=10&&(t-=5),t},e.isWorthCoupon=function(){return e.getTotalCost()>=10},e.changeQuantity=function(n,r,t){"+"===t?e.cart.changeQuantity(n,++r):e.cart.changeQuantity(n,--r)},e.removeItem=function(n){e.cart.removeItem(n)},e.registration={},e.phonenumber=l.get("phonenumber",null),e.registerDeviceWithOldCode=function(){e.account.view="enter-code",e.secret="code:renew",e.$$phase||e.$apply()},e.goBack=function(){e.account.view="unlock-phone"},e.registerDevice=function(){"cordova"in window;var r=angular.copy(e.registration);e.phonenumber=r.phonenumber,l.set("phonenumber",r.phonenumber),e.resendSMS=function(){o.post(i.to("users/send_verification_sms"),{phonenumber:e.phonenumber}).then(function(e){"ok"==e.success?alert("Eine neue SMS wurde dir zugesandt."):e.error&&alert(e.error)},function(){alert("Wir konnten dir keine SMS zusenden, versuche es später noch einmal oder melde dich telefonisch unter 06434 90 99 40."),n.$broadcast("loading:hide")})},o.post(i.to("users/create"),{user:{phonenumber:r.phonenumber}}).success(function(n){return"cordova"in window,"undefined"!=typeof n.code&&alert("CODE: --> "+n.code+" <-- / Zu Testzwecken wird der Code nicht per SMS verschickt."),n.error?void f.alert(n.error,"Fehler bei der Registrierung.","OK"):(e.account.view="enter-code",void(e.secret=n.secret))}).error(function(){"cordova"in window})},e.verifySMSCode=function(r){return"cordova"in window,"undefined"==typeof e.phonenumber||""==e.phonenumber||e.phonenumber.length<4?(f.alert("Du hast keine mobile Rufnummer angegeben, bitte gebe eine gültige Handynummer ein und versuche es erneut.","Fehler bei Überprüfung des SMS Codes","OK"),e.account.view="unlock-phone",e.$$phase||e.$apply(),!1):void o.post(i.to("users/verify"),{code:r,phonenumber:e.phonenumber}).success(function(n){return"cordova"in window,n.error?void f.alert(n.error,"Fehler bei der Registrierung.","OK"):(e.account.signedIn=!0,void e.account.saveCredentials({signedIn:!0,phonenumber:e.phonenumber,secret:e.secret}))}).error(function(){"cordova"in window&&(n.$broadcast("loading:hide"),alert("Da ist etwas schief gelaufen! Bitte versuche es später noch einmal."))})}});